"""Tests for the EARN-E P1 Meter sensor platform."""

from __future__ import annotations

from unittest.mock import AsyncMock, patch

import pytest

from homeassistant.core import HomeAssistant
from homeassistant.helpers import device_registry as dr, entity_registry as er

from custom_components.earn_e_p1.const import DOMAIN
from custom_components.earn_e_p1.coordinator import EarnEP1Coordinator

from .conftest import MOCK_HOST, MOCK_SERIAL


async def _setup_integration(hass: HomeAssistant, mock_config_entry) -> EarnEP1Coordinator:
    """Set up the integration and return the coordinator."""
    with patch(
        "custom_components.earn_e_p1.coordinator.EarnEP1Coordinator.async_start",
        new_callable=AsyncMock,
    ):
        await hass.config_entries.async_setup(mock_config_entry.entry_id)
        await hass.async_block_till_done()

    return mock_config_entry.runtime_data


async def test_sensors_created(hass: HomeAssistant, mock_config_entry) -> None:
    """Test that sensors are created on setup."""
    coordinator = await _setup_integration(hass, mock_config_entry)

    # Simulate receiving data
    coordinator.async_set_updated_data({"power_delivered": 1.234})
    await hass.async_block_till_done()

    state = hass.states.get("sensor.earn_e_p1_meter_power_delivered")
    assert state is not None
    assert state.state == "1.234"


async def test_sensor_unavailable_without_data(
    hass: HomeAssistant, mock_config_entry
) -> None:
    """Test sensor is unavailable when no data has been received."""
    await _setup_integration(hass, mock_config_entry)
    await hass.async_block_till_done()

    state = hass.states.get("sensor.earn_e_p1_meter_power_delivered")
    assert state is not None
    assert state.state == "unavailable"


async def test_sensor_unavailable_when_key_missing(
    hass: HomeAssistant, mock_config_entry
) -> None:
    """Test sensor is unavailable when its specific key is missing from data."""
    coordinator = await _setup_integration(hass, mock_config_entry)

    # Set data that doesn't include power_returned
    coordinator.async_set_updated_data({"power_delivered": 1.0})
    await hass.async_block_till_done()

    state = hass.states.get("sensor.earn_e_p1_meter_power_returned")
    assert state is not None
    assert state.state == "unavailable"


async def test_sensor_native_value(hass: HomeAssistant, mock_config_entry) -> None:
    """Test sensor returns correct native value."""
    coordinator = await _setup_integration(hass, mock_config_entry)

    coordinator.async_set_updated_data({
        "power_delivered": 2.5,
        "voltage_l1": 230.1,
        "energy_delivered_tariff1": 12345.678,
    })
    await hass.async_block_till_done()

    assert hass.states.get("sensor.earn_e_p1_meter_power_delivered").state == "2.5"
    assert hass.states.get("sensor.earn_e_p1_meter_voltage_l1").state == "230.1"
    assert hass.states.get("sensor.earn_e_p1_meter_energy_delivered_tariff_1").state == "12345.678"


async def test_device_info(hass: HomeAssistant, mock_config_entry) -> None:
    """Test device info is correct."""
    coordinator = await _setup_integration(hass, mock_config_entry)

    coordinator.model = "P1-Monitor"
    coordinator.sw_version = "1.2.3"
    coordinator.async_set_updated_data({"power_delivered": 1.0})
    await hass.async_block_till_done()

    # Verify device was registered with correct identifiers
    device_registry = dr.async_get(hass)
    device = device_registry.async_get_device(identifiers={(DOMAIN, MOCK_SERIAL)})
    assert device is not None
    assert device.name == "EARN-E P1 Meter"
    assert device.manufacturer == "EARN-E"

    # Verify entity's device_info property returns up-to-date info
    entity_registry = er.async_get(hass)
    entity_entry = entity_registry.async_get("sensor.earn_e_p1_meter_power_delivered")
    entity = hass.data["entity_components"]["sensor"].get_entity(
        entity_entry.entity_id
    )
    info = entity.device_info
    assert info["model"] == "P1-Monitor"
    assert info["sw_version"] == "1.2.3"


async def test_sensor_unique_id_uses_serial(
    hass: HomeAssistant, mock_config_entry
) -> None:
    """Test that sensor unique_id uses serial when available."""
    coordinator = await _setup_integration(hass, mock_config_entry)

    coordinator.async_set_updated_data({"power_delivered": 1.0})
    await hass.async_block_till_done()

    entity_registry = er.async_get(hass)
    entry = entity_registry.async_get("sensor.earn_e_p1_meter_power_delivered")
    assert entry is not None
    assert entry.unique_id == f"{MOCK_SERIAL}_power_delivered"
